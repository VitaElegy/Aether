# 讨论：用户权限管理系统 (User Permission System)
日期: 2026-02-04
主题: 设计完善的用户权限管理系统，支持角色调整和功能开关。

## 背景
用户希望在 `User Management` 界面调控用户权限（如将普通用户变为协作者，开启查看文章权限等）。需要建立一套完善的权限系统。

## 问答记录

### 问题 1: 核心权限模型 (Core Permission Model)
**提问**: 我们需要确定系统的底层权限模型。
目前主流有三种模式，您倾向于哪种？

1.  **RBAC (基于角色的访问控制) - 推荐**:
    *   用户被分配一个"角色" (Role)，如 Admin, Collaborator, Viewer。
    *   权限挂在"角色"上，而不是直接挂在用户上。（修改角色的权限，所有该角色的用户都会生效）
    *   *优点*: 管理最方便，符合大多数 SaaS 标准。
2.  **ACL (访问控制列表)**:
    *   直接给每个用户单独开关一个个具体的功能（"是否允许查看文章?", "是否允许评论?"）。
    *   *优点*: 极其灵活，可以给每个人完全不同的配置。
    *   *缺点*: 用户多了以后管理是噩梦。
3.  **Hybrid (混合模式)**:
    *   有基础角色 (Role)，但也允许给特定用户"额外"开启/关闭特定权限 (Permission Overrides)。
    *   *优点*: 兼顾标准和灵活。
    *   *缺点*: 开发复杂度最高。

**您的选择是？**

**回答**: **您是对的，我的初步排查只看到了表象。**

深入检查 `backend/src/domain/permission_service.rs` 后，我发现您的系统已经实现了一套极其先进的 **ReBAC (Relational Based Access Control，基于关系的访问控制)** 模型，这与 **Google Zanzibar** 的设计理念非常相似。

*   **真正的核心**: 并不是那个 `u64` bitmask (那只是为了兼容旧代码或超级管理员预留的)。
*   **实际逻辑**: 权限是基于 **"Tuple (元组)"** 的图关系检查。
    *   代码正在检查：`check_relation(node_id, "node", "editor", user_id)`
    *   支持 **Group (组)**: 用户属于组，组拥有权限。
    *   支持 **Inheritance (继承)**: 权限可以从文件夹/父节点继承。

**这是一个非常强大且现代的模型。**
因此，我们的 UI 设计不应该是 "修改 Bitmask"，而应该是 **"管理关系 (Manage Relations)"**。

*   "设为协作者" -> 其实是在后台添加一条 Tuple: `(KnowledgeBase, "editor", User)`。
*   "允许查看文章" -> 添加 Tuple: `(Article, "viewer", User)`。

### 问题 2: 如何在 UI 上呈现这种先进模型？ (UI Representation)

既然底层是 ReBAC，UI 就不能只是简单的 "开关检查"。我们需要设计一种 "角色/组" 的映射。

**方案建议**:
我们在 UI 层虚构出 "Role" 的概念，但实际上它是**一组 Tuple 的集合**。

**场景**:
当管理员在 UI 上把张三设为 **"Content Collaborator"** 时，系统实际上执行：
1.  确保系统里有一个叫 `Content_Collaborators` 的 **Group**。
2.  添加 Tuple: `(System, "group_member", 张三)`.
3.  (预先配置好): `Content_Collaborators` 这个组已经被赋予了 `create_content`, `edit_content` 等权限。

**回答**: **(用户已确认)** 同意。用户特别强调：**颗粒度要足够细节**，并且此模型必须作为后续所有 AI 的开发标准，写入文档中。

> **系统动作**: 已将 ReBAC 标准写入 `AI/const/project_spec.md` 及新建 `AI/skills/rebac_schema.md`。

### 问题 3: 细化颗粒度 (Granularity Definition)
**提问**: 既然要求"颗粒度足够细节"，我们需要明确 UI 上可以控制哪些**具体的资源**和**具体的动作**。

请问除了"全局协作者"这种大角色外，您希望在 User Management 界面能直接控制到**什么级别的资源**？

**选项 A: 仅系统级 (System Level)**
*   控制："是否允许登录后台", "是否允许管理用户", "全局发文章权限"。
*   *适合*: 简化管理。

**选项 B: 模块级 (Module Level)**
*   控制："Memos 模块编辑权", "KnowledgeBase 模块创建权", "VRKB 模块查看权"。
*   *适合*: 按功能模块划分团队。

**选项 C: 实例级 (Instance Level - 最细)**
*   控制："只能看《技术文档》这个知识库", "只能编辑 ID=123 的这篇文章"。
*   *(注意: 在用户管理列表页做这个通过 UI 会很复杂，通常是在文章详情页做。但如果你想在用户页集中管理，我们需要设计专门的弹窗)*

**回答**: **(用户已确认)** 选择 **选项 C: 实例级 (Instance Level)**。
用户明确要求：
1.  控制力度必须支持到 **特定知识库** 和 **特定文章 ID**。
2.  支持在 User Management 界面通过 **"授权清单"弹窗** 来集中管理这些权限。

### 问题 4: 授权管理交互设计 (Authorization UI Flow)
**提问**: 既然要在用户列表页管理"成千上万"的潜在资源权限，我们需要一个高效的交互设计。

我建议在用户列表的"操作"列增加一个 **[权限管理]** 按钮，点击后打开一个 **侧边抽屉 (Drawer)** 或 **大弹窗 (Modal)**。

在这个弹窗中，您希望看到什么样的布局？

**方案 A: 分层试图 (Hierarchy View)**
*   **上部**: **角色/用户组** (如: "系统管理员", "全职编辑") - *勾选即可*。
*   **下部**: **独立资源授权列表** (Explicit Grants)。
    *   列出该用户被**单独授权**的所有资源 (如: KB-技术文档 [Editor], Article-123 [Viewer])。
    *   提供一个 **[+ 添加授权]** 按钮 -> 弹出资源搜索框 -> 搜索 KB/文章 -> 选择权限 -> 确定。

**方案 B: 纯搜索流 (Search-First)**
*   没有复杂的列表，直接是一个搜索框。
*   搜到资源后，直接显示当前用户对该资源的权限状态并进行修改。

**回答**: **(用户已确认)** 选择 **方案 A: 分层视图 (Hierarchy View)**。
用户偏好清晰的清单管理模式，希望能明确看到分配了哪些角色，以及额外单独授权了哪些资源。

### 问题 5: 否定权限 (Negative Permissions / "Deny" Rules)
**提问**: 在权限逻辑中，通常有两种策略：
1.  **纯叠加 (Additive Only) - 推荐**: 权限只增不减。
    *   如果你是 "Editor" 组员，你就自动拥有组内所有资源权限。
    *   *无法* 实现 "除了某个文件外，其他都能看"。
    *   *优点*: 逻辑简单高性能 (Google Zanzibar 默认模式)。
2.  **支持拒绝 (Allow + Deny)**: 允许显式的 "黑名单"。
    *   可以设置：用户对 文件夹 A 有 Viewer 权限，但对 文件夹 A/秘密文件 B 设置 **Deny**。
    *   *缺点*: 计算极复杂 (需要处理优先级)，容易产生逻辑冲突。

**回答**: **(用户已确认)** 选择 **选项 A: 纯叠加 (Additive Only)**。
这是最稳健的选择。系统将遵循 "存在即允许" 原则，不引入复杂的 Deny 逻辑。

### 问题 6: 审计与变更记录 (Audit & History)
**提问**: 权限变更是极其敏感的操作。
目前的 `SystemLogs.vue` 似乎记录了通用的系统日志，但在 User Management 界面中，当管理员通过"授权弹窗"修改了某人的权限时：

您是否希望在**弹窗内**直接看到该用户的 **"权限变更历史"**？
(例如: "2026-02-04 Admin 张三 将用户加入 'Editor' 组")

**选项 A: 需要 (审计优先)**
*   在授权弹窗底部增加一个 "History" Tab，专门显示该用户的权限变动记录。
*   *适合*: 对安全性要求高的场景。

**选项 B: 不需要 (简化 UI)**
*   变更记录只统一记入后台的 `System Logs`，弹窗内只显示当前状态。
*   *适合*: 追求 UI 简洁。

**回答**: **(用户已确认)** 选择 **选项 A: 需要 (审计优先)**。
用户明确要求在授权弹窗底部增加 **"History" 标签页**，以便追溯："谁、在什么时候、修改了什么权限"。

### 问题 7: 默认可见性与继承 (Default Visibility & Inheritance)
**提问**: 当一个用户创建一个新的 **Knowledge Base (知识库)** 或 **Folder (文件夹)** 时，它的默认权限应该是什么？

**选项 A: 私有优先 (Private by Default)**
*   只有**创建者** (Owner) 和 **超级管理员** 能看到。
*   必须显式添加 "Editors Group" 或特定人员才能共享。
*   *适合*: 强隐私场景。

**选项 B: 开放优先 (Open/Internal by Default)**
*   默认对 **"全员 (Internal Users)"** 开放 **Viewer** 权限。
*   *适合*: 企业内部知识共享，鼓励透明。

**选项 C: 继承优先 (Inherit Parent)**
*   (仅针对文件夹/文章) 自动复制父级文件夹的权限设置。
*   **KB 级别** 仍需选择 A 或 B。

**回答**: **(用户已确认)** 选择 **选项 A: 私有优先 (Private by Default)**。
创建者拥有绝对控制权。除非显式分享，否则资源默认隔离。

### 问题 8: 超级管理员权限 (Super Admin Strategy)
**提问**: 既然选了 "私有优先"，那么对于 **系统超级管理员 (Super Admin)** 来说，他们能看到用户的私有内容吗？

**选项 A: 上帝模式 (God Mode) - 隐式访问**
*   Admin 自动拥有所有资源的 Viewer/Editor 权限。
*   用户列表里看不到 Admin，但 Admin 实际上能打开任何链接。
*   *优点*: 运维极其方便。
*   *缺点*: 隐私合规性较差，管理员可能无意间看到不该看的东西。

**选项 B: 破窗模式 (Break-Glass) - 显式获取**
*   Admin **默认看不到** 用户的私有内容。
*   Admin 拥有 **"所有权接管 (Take Ownership)"** 或 **"强制授权"** 的能力。
*   如果 Admin 需要介入，必须先在后台点击 "获取权限" (这会留下一条醒目的审计日志)，然后才能查看。
*   *优点*: 极高的隐私合规性 (审计友好)。

**回答**: **(用户已确认)** 选择 **选项 B: 破窗模式 (Break-Glass)**。
这是最符合合规性和隐私保护的设计。
*   管理员日常无权查看私有数据。
*   紧急情况下，必须通过 **[强制获取]** 按钮介入。
*   系统会产生高危审计日志。

### 问题 9: 外部共享与公开访问 (External Sharing)
**提问**: 除了系统内的用户，我们是否允许 **"匿名公开访问"**？

目前后端代码已经预埋了 `Group:Public (Nil UUID)`。
我们如何定义 "Public"？

**选项 A: 仅登录用户 (Internal Public)**
*   "公开" 意味着 "所有注册并登录的 **Aether 用户** 都能看"。
*   游客（未登录）无法访问。
*   *适合*: 纯内部系统。

**选项 B: 互联网公开 (Internet Public)**
*   允许将页面设为 "Public Web"。
*   任何互联网访客都可以查看（底层映射为 `Group:Anonymous`）。
*   *适合*: 博客、公开文档站。

**选项 C: 密钥分享 (Secret Links)**
*   不完全公开，生成一个 `aether.com/s/7x9d8...` 的 **加密链接**。
*   只要有链接的人就能看，不需要账号。
*   *适合*: 临时分享给客户/朋友。

**回答**: **(用户已确认)** 选择 **选项 A (仅限组织内)** 和 **选项 C (密钥链接)**。
*   **拒绝** 完全的互联网公开 (Public Web)。
*   系统将是一个 **"半封闭"** 系统：核心内容需登录，但也允许通过密钥链接临时分享给外部合作伙伴。

### 问题 10: 组管理权 (Group Management & Delegation)
**提问**: (最后一个问题) ReBAC 的核心是 **Group (组)**。
请问 **"谁有权创建和管理组"**？

**选项 A: 仅管理员 (IT-Driven)**
*   只有系统管理员能在后台创建 "开发组", "市场组"。
*   普通用户只能被动加入，只能对"人"分享，不能对"组"分享（除非选了系统预设组）。
*   *适合*: 结构稳定的组织。

**选项 B: 自助团队 (User-Managed Teams)**
*   允许普通用户(或协作者) 创建自己的 **"Team / Squad"**。
*   例如：张三创建一个 "项目A攻坚组"，把李四王五拉进去，然后把他的知识库分享给这个组。
*   *适合*: 灵活协作、扁平化组织。

**回答**: **(用户已确认)** 选择 **选项 B: 自助团队 (User-Managed Teams)**。
允许普通用户创建自己的小组 (Team/Squad)，以支持灵活的扁平化协作。

## 总结 (Final Specification)
本次讨论确定了 User Permission System 的 10 大核心设计原则：

1.  **核心模型**: **ReBAC (Zanzibar-style)** (基于 Tuples 的关系模型)。
2.  **UI 映射**: UI 呈现为 "角色"，底层映射为 ReBAC Group + Tuple。
3.  **颗粒度**: **实例级 (Instance Level)**。支持对特定 KB/文章 的授权。
4.  **UI 交互**: **分层视图 (Hierarchy View)**。上部角色勾选，下部显式资源清单。
5.  **逻辑策略**: **纯叠加 (Additive Only)**。无 Deny 规则。
6.  **审计**: **强制审计 (In-Modal History)**。弹窗内展示权限变更历史。
7.  **默认可见性**: **私有优先 (Private by Default)**。
8.  **超级管理员**: **破窗模式 (Break-Glass)**。Admin 默认无权，需手动"强制获取"并记录高危审计。
9.  **外部共享**: **半封闭 (Internal + Secret Links)**。拒绝完全公开的互联网访问。
10. **组管理**: **自助团队 (User-Managed)**。允许用户自由建组。

> **状态**: 需求确认完毕，已写入 `AI/skills/rebac_schema.md`。
