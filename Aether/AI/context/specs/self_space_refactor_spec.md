# Self Space æ¶æ„é‡æ„è§„èŒƒ V2

> **ç‰ˆæœ¬**: 2.0
> **æ—¥æœŸ**: 2026-01-30
> **çŠ¶æ€**: å·²å®ç° âœ…
> **è®¨è®ºè®°å½•**: [self_space_refactor_discussion.md](file:///Users/elegy/Documents/READING/LINUX/Aether/Aether/AI/memory/discussions/self_space_refactor_discussion.md)

---

## 1. æ¦‚è¿°

### 1.1 é—®é¢˜é™ˆè¿°
- è¿›å…¥ç‰¹æ®ŠçŸ¥è¯†åº“æ—¶ `self_space` æ˜¾ç¤ºç©ºç™½
- `dockItems` èŒè´£è¿‡é‡ï¼ŒåŒæ—¶æ‰¿æ‹… UI æ¸²æŸ“å’Œç»„ä»¶è§£æ
- æ’ä»¶æ³¨å†Œæ—¶æœºä¸ç¡®å®šï¼Œå­˜åœ¨ç«æ€æ¡ä»¶
- é”™è¯¯å¤„ç†ç²—ç³™ï¼Œç¼ºä¹æ¢å¤æœºåˆ¶

### 1.2 ç›®æ ‡
- å®ç° macOS é£æ ¼çš„ Dock åˆ†åŒºä¸å»é‡é€»è¾‘
- å»ºç«‹ç¨³å®šçš„æ’ä»¶æ‡’åŠ è½½æœºåˆ¶
- é‡æ„ä¸º Orchestrator æ¨¡å¼çš„çŠ¶æ€ç®¡ç†
- å®ç°ä¸‰å±‚é”™è¯¯é˜²å¾¡æ¶æ„

---

## 2. æ¶æ„è®¾è®¡

### 2.1 Dock ç³»ç»Ÿï¼ˆmacOS é£æ ¼ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [å›ºå®šåŒº - Pinned]        â”‚  [è¿è¡ŒåŒº - Running]  â”‚ [Exit]  â”‚
â”‚   ğŸ  Library              â”‚   ğŸ“ Math KB         â”‚   ğŸšª   â”‚
â”‚   ğŸ“ Memos  â€¢            â”‚                      â”‚         â”‚
â”‚   ğŸ”¤ English â—‰           â”‚                      â”‚         â”‚
â”‚     (è¿è¡Œä¸­=åœ†ç‚¹)          â”‚    (é Pinned)       â”‚         â”‚
â”‚     (æ¿€æ´»=å…‰ç¯)            â”‚                      â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒè§„åˆ™**ï¼š
1. Pinned KB æ°¸è¿œåªåœ¨å›ºå®šåŒºæ˜¾ç¤ºï¼Œä¸åœ¨è¿è¡ŒåŒºé‡å¤
2. è¿è¡ŒçŠ¶æ€ï¼šå›¾æ ‡ä¸‹æ–¹æ˜¾ç¤ºå°åœ†ç‚¹ `â€¢`
3. æ¿€æ´»çŠ¶æ€ï¼šå›¾æ ‡æ·»åŠ å¾®å…‰ç¯æ•ˆæœ
4. é Pinned KB åªåœ¨è¿è¡Œæ—¶å‡ºç°åœ¨è¿è¡ŒåŒºï¼Œå…³é—­åæ¶ˆå¤±

### 2.2 æ’ä»¶ç³»ç»Ÿï¼ˆæ··åˆåŠ è½½ï¼‰

```typescript
// æ ¸å¿ƒæ¥å£å®šä¹‰
interface SkbPluginManifest {
    sys_id: string;                    // å”¯ä¸€æ ‡è¯† (math, english, memos...)
    activation: {
        events: ActivationEvent[];      // è§¦å‘æ¡ä»¶
        eager?: boolean;                // true = å¯åŠ¨æ—¶åŠ è½½
    };
    view: {
        component: () => Promise<Component>;  // åŠ¨æ€å¯¼å…¥
    };
}

type ActivationEvent =
    | { type: 'onKbOpen'; renderer_id: string }
    | { type: 'onStartupFinished' }
    | { type: 'always' };
```

**åŠ è½½ç­–ç•¥**ï¼š
| æ’ä»¶ç±»å‹ | åŠ è½½æ—¶æœº   | ç¤ºä¾‹                               |
| -------- | ---------- | ---------------------------------- |
| æ ¸å¿ƒæ’ä»¶ | å¯åŠ¨æ—¶     | `knowledge`, `admin`               |
| ç‰¹æ®Š KB  | é¦–æ¬¡è®¿é—®æ—¶ | `math`, `english`, `memos`, `vrkb` |

### 2.3 çŠ¶æ€æ¶æ„ï¼ˆOrchestrator æ¨¡å¼ï¼‰

```typescript
// useSelfSpaceOrchestrator.ts
export function useSelfSpaceOrchestrator() {
    const appStore = useAppStateStore();
    const pluginStore = usePluginStore();
    const prefStore = usePreferencesStore();

    // æ ¸å¿ƒå…¥å£
    async function switchToKb(kbId: string): Promise<void> {
        // 1. éªŒè¯ KB å­˜åœ¨
        const kb = await ensureKbMetadata(kbId);
        if (!kb) throw new Error(`KB not found: ${kbId}`);

        // 2. ç¡®ä¿æ’ä»¶å·²åŠ è½½
        const rendererId = kb.renderer_id || 'knowledge';
        await ensurePluginLoaded(rendererId);

        // 3. æ›´æ–°çŠ¶æ€
        appStore.switchKB(kbId);

        // 4. å‘é€äº‹ä»¶ï¼ˆæ‰©å±•ç‚¹ï¼‰
        eventBus.emit('kb:activated', { kbId, rendererId });
    }

    // æ´¾ç”ŸçŠ¶æ€
    const dockItems = computed(() => buildDockItems());
    const currentComponent = computed(() => resolveComponent());
    
    // Loading çŠ¶æ€
    const isLoading = ref(false);
    const loadingKbId = ref<string | null>(null);

    return {
        switchToKb,
        dockItems,
        currentComponent,
        isLoading,
        loadingKbId
    };
}
```

### 2.4 é”™è¯¯é˜²å¾¡æ¶æ„ï¼ˆä¸‰å±‚ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: Global Error Handler                                â”‚
â”‚  ä½ç½®: main.ts â†’ app.config.errorHandler                      â”‚
â”‚  èŒè´£: æ—¥å¿—æ”¶é›†, Toast é€šçŸ¥                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 2: KB-Level Error Boundary                             â”‚
â”‚  ä½ç½®: SelfSpaceView.vue â†’ onErrorCaptured                    â”‚
â”‚  èŒè´£: æ•è· KB ç»„ä»¶é”™è¯¯, æ˜¾ç¤º BrokenState.vue                  â”‚
â”‚  æ¢å¤é€‰é¡¹: é‡è¯• / è¿”å› Library / æŠ¥å‘Šé—®é¢˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 3: Async Loading Fallback                              â”‚
â”‚  ä½ç½®: LoadingState.vue (æ–°å»º)                                â”‚
â”‚  èŒè´£: æ‡’åŠ è½½éª¨æ¶å±, è¶…æ—¶æç¤º, å¤±è´¥é¡ºå»¶åˆ° Layer 2              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. æ–‡ä»¶å˜æ›´è®¡åˆ’

### 3.1 æ–°å»ºæ–‡ä»¶

| æ–‡ä»¶è·¯å¾„                                               | æè¿°           |
| ------------------------------------------------------ | -------------- |
| `frontend/src/composables/useSelfSpaceOrchestrator.ts` | æ ¸å¿ƒåè°ƒå™¨     |
| `frontend/src/components/self-space/LoadingState.vue`  | åŠ è½½éª¨æ¶å±     |
| `frontend/src/utils/eventBus.ts`                       | è½»é‡çº§äº‹ä»¶æ€»çº¿ |

### 3.2 é‡æ„æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„                                                | å˜æ›´æè¿°                |
| ------------------------------------------------------- | ----------------------- |
| `frontend/src/views/SelfSpaceView.vue`                  | é‡æ„ä¸ºä½¿ç”¨ Orchestrator |
| `frontend/src/stores/plugins.ts`                        | æ·»åŠ æ‡’åŠ è½½æ”¯æŒ          |
| `frontend/src/components/self-space/ModuleSwitcher.vue` | æ”¯æŒçŠ¶æ€æŒ‡ç¤º            |
| `frontend/src/components/self-space/BrokenState.vue`    | å¢å¼ºæ¢å¤é€‰é¡¹            |

### 3.3 ä¿æŒä¸å˜

| æ–‡ä»¶è·¯å¾„                                | åŸå›                  |
| --------------------------------------- | -------------------- |
| `frontend/src/stores/read_app_state.ts` | æ ¸å¿ƒçŠ¶æ€æ¨¡å‹æ— éœ€æ”¹åŠ¨ |
| `frontend/src/stores/preferences.ts`    | Pin é€»è¾‘ä¿æŒä¸å˜     |

---

## 4. éªŒè¯è®¡åˆ’

### 4.1 è‡ªåŠ¨åŒ–æµ‹è¯•
```bash
# è¿è¡Œå‰ç«¯ lint å’Œç±»å‹æ£€æŸ¥
npm run lint
npm run type-check
```

### 4.2 æ‰‹åŠ¨éªŒè¯åœºæ™¯

| åœºæ™¯             | é¢„æœŸè¡Œä¸º                             |
| ---------------- | ------------------------------------ |
| ç‚¹å‡» Pinned KB   | æ˜¾ç¤ºåŠ è½½éª¨æ¶å± â†’ æ¸²æŸ“ Dashboard      |
| ç‚¹å‡»é Pinned KB | æ·»åŠ åˆ°è¿è¡ŒåŒº â†’ æ˜¾ç¤ºåŠ è½½éª¨æ¶å± â†’ æ¸²æŸ“ |
| KB åŠ è½½å¤±è´¥      | æ˜¾ç¤º BrokenState + é‡è¯•æŒ‰é’®          |
| å…³é—­é Pinned KB | ä»è¿è¡ŒåŒºæ¶ˆå¤±                         |
| Pinned KB è¿è¡Œä¸­ | æ˜¾ç¤ºå°åœ†ç‚¹ + å…‰ç¯                    |

---

## 5. å®ç°ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | ä»»åŠ¡                                       | ä¼°æ—¶ |
| ------ | ------------------------------------------ | ---- |
| P0     | åˆ›å»º `useSelfSpaceOrchestrator`            | 2h   |
| P0     | é‡æ„ `SelfSpaceView.vue` ä½¿ç”¨ Orchestrator | 2h   |
| P1     | å®ç°æ’ä»¶æ‡’åŠ è½½æœºåˆ¶                         | 1.5h |
| P1     | åˆ›å»º `LoadingState.vue`                    | 0.5h |
| P2     | å¢å¼º `BrokenState.vue` æ¢å¤é€‰é¡¹            | 0.5h |
| P2     | å®ç° Dock è§†è§‰çŠ¶æ€æŒ‡ç¤º                     | 1h   |
| P3     | æ·»åŠ äº‹ä»¶æ€»çº¿æ‰©å±•ç‚¹                         | 0.5h |

**æ€»ä¼°æ—¶**: ~8 å°æ—¶
