<template>
    <div class="h-full flex flex-col p-6 overflow-hidden">
        <!-- Clean Header -->
        <div class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-4 group">
                <button @click="handleBack" class="w-8 h-8 flex items-center justify-center rounded-full bg-white shadow-sm border border-ash/20 text-ink/60 hover:text-ink hover:scale-105 transition-all" title="Back">
                    <i class="ri-arrow-left-line"></i>
                </button>
                <div>
                    <div class="text-[10px] font-bold uppercase tracking-widest text-ink/40 mb-0.5">Project Workspace</div>
                    <h2 class="text-2xl font-black font-serif text-ink tracking-tight">
                        {{ currentProject?.name }}
                    </h2>
                </div>
            </div>
            
            <!-- Project Navigation Tabs (Minimalist) -->
            <div class="flex items-center gap-6 px-2">
                 <button 
                    v-for="view in views" 
                    :key="view.id"
                    @click="currentView = view.id"
                    class="text-sm font-bold transition-all relative py-1"
                    :class="currentView === view.id ? 'text-ink' : 'text-ink/40 hover:text-ink'"
                >
                    {{ view.label }}
                    <!-- Active Indicator -->
                    <div v-if="currentView === view.id" class="absolute -bottom-1 left-0 right-0 h-0.5 bg-accent rounded-full"></div>
                </button>
            </div>

            <div class="flex gap-3">
                <div class="flex -space-x-2 mr-4">
                     <!-- Collaborators Mock -->
                    <div class="w-8 h-8 rounded-full border-2 border-white bg-ash" title="Team Members"></div>
                    <div class="w-8 h-8 rounded-full border-2 border-white bg-accent/20 flex items-center justify-center text-[10px] font-bold text-accent">+</div>
                </div>
                <!-- Only show "New Finding" in Lifecycle view -->
                <button v-if="currentView === 'lifecycle'" class="px-4 py-2 bg-accent text-white hover:bg-accent/90 shadow-lg shadow-accent/20 rounded-lg text-xs font-bold uppercase tracking-wider transition-all flex items-center gap-2" @click="openCreateModal('Triage')">
                    <i class="ri-add-line text-lg"></i> New Finding
                </button>
            </div>
        </div>

        <!-- View Content Area -->
        
        <!-- 0. Overview (Dashboard) -->
        <div v-if="currentView === 'overview'" class="flex-1 overflow-hidden">
             <OverviewDashboard />
        </div>

        <!-- 1. Lifecycle (Kanban) -->
        <div v-else-if="currentView === 'lifecycle'" class="flex-1 flex gap-6 overflow-x-auto pb-4 px-1">
            <div 
                v-for="col in columns" 
                :key="col.id"
                class="flex-shrink-0 w-80 flex flex-col"
                @dragover.prevent
                @drop="onDrop($event, col.id)"
            >
                <!-- Column Header (Floating) -->
                <div class="flex items-center justify-between mb-4 px-1">
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full" :class="col.color"></span>
                        <span class="font-bold text-sm text-ink/80">{{ col.label }}</span>
                    </div>
                    <div class="bg-ash/50 text-ink/60 text-[10px] font-bold px-2 py-0.5 rounded-full">{{ getFindings(col.id).length }}</div>
                </div>

                <!-- Column Body (No Background) -->
                <div class="flex-1 overflow-y-auto min-h-0 pr-2 -mr-2 space-y-3 pb-2">
                    <div 
                        v-for="finding in getFindings(col.id)" 
                        :key="finding.id"
                        draggable="true"
                        @dragstart="onDragStart($event, finding)"
                        class="bg-white/80 backdrop-blur-sm p-4 rounded-xl border border-ash/20 hover:border-accent/40 shadow-sm hover:shadow-md cursor-grab active:cursor-grabbing transition-all group relative overflow-hidden"
                    >
                        <!-- Severity Indicator Strip -->
                        <div class="absolute left-0 top-0 bottom-0 w-1" :class="getSeverityClass(finding.severity, true)"></div>

                        <div class="flex justify-between items-start mb-2 pl-2">
                            <span class="text-[10px] font-bold uppercase tracking-wider text-ink/40">{{ finding.id.slice(0, 8) }}</span>
                            <span class="text-[10px] font-medium text-ink/40 bg-ash/50 px-1.5 py-0.5 rounded">{{ formatDate(finding.created_at) }}</span>
                        </div>
                        
                        <h4 class="text-sm font-bold text-ink leading-snug mb-3 pl-2">{{ finding.title }}</h4>
                        
                        <div class="flex items-center justify-between pt-2 pl-2 mt-auto">
                            <span 
                                class="text-[10px] font-bold px-2 py-1 rounded-md"
                                :class="getSeverityClass(finding.severity)"
                            >
                                {{ finding.severity }}
                            </span>
                            <button @click="openEditor(finding)" class="w-6 h-6 flex items-center justify-center rounded hover:bg-ash text-ink/40 hover:text-accent transition-colors">
                                <i class="ri-edit-line"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Empty State Placeholder -->
                    <div v-if="getFindings(col.id).length === 0" class="h-24 border-2 border-dashed border-ash/30 rounded-xl flex items-center justify-center text-ink/20 text-xs font-medium italic">
                        No findings
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. Asset Browser -->
        <div v-else-if="currentView === 'assets'" class="flex-1 overflow-hidden">
            <AssetBrowser v-if="currentProject" :project-id="currentProject.id" />
        </div>

        <!-- 3. Team Management -->
        <div v-else-if="currentView === 'team'" class="flex-1 overflow-hidden">
             <TeamManagement />
        </div>

        <!-- 4. Project Specs -->
        <div v-else-if="currentView === 'specs'" class="flex-1 overflow-hidden">
             <ProjectSpecs />
        </div>

        <!-- 5. Documentation -->
        <div v-else-if="currentView === 'docs'" class="flex-1 overflow-hidden">
             <DocRepo />
        </div>

        <!-- Fallback -->
        <div v-else class="flex-1 flex flex-col items-center justify-center opacity-50">
            <div class="w-24 h-24 bg-ash/30 rounded-full flex items-center justify-center mb-6">
                 <i class="ri-tools-line text-4xl text-ink/20"></i>
            </div>
            <h3 class="text-xl font-bold font-serif text-ink tracking-tight mb-2">{{ views.find(v => v.id === currentView)?.label }}</h3>
            <p class="text-sm text-ink/40 max-w-xs text-center">This module is currently being built. Check back later for updates.</p>
        </div>

        <!-- Editor Modal -->
        <div v-if="showEditor" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
            <div class="bg-paper rounded-xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col border border-ink/10">
                <div class="p-4 border-b border-ink/10 flex justify-between items-center">
                    <h3 class="font-bold font-serif text-lg">{{ editingFinding?.title }}</h3>
                    <button @click="saveEditor" class="px-3 py-1.5 bg-accent text-white hover:bg-accent/90 border border-transparent rounded text-xs font-medium transition-colors flex items-center gap-1">
                        Save Close
                    </button>
                </div>
                <div class="flex-1 p-4 overflow-hidden">
                    <FindingEditor v-model="editorContent" />
                </div>
            </div>
        </div>
    </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, watch } from 'vue';
import { useVrkbStore, type VrkbFinding } from '@/stores/vrkb';
import { DateTime } from 'luxon';
import FindingEditor from './FindingEditor.vue';
import AssetBrowser from './views/AssetBrowser.vue';
import OverviewDashboard from './views/OverviewDashboard.vue';
import TeamManagement from './views/TeamManagement.vue';
import ProjectSpecs from './views/ProjectSpecs.vue';
import DocRepo from './views/DocRepo.vue';

import { useRouter } from 'vue-router'; // [NEW]

import { useRoute } from 'vue-router'; // [NEW] import useRouter is already there

const store = useVrkbStore();
const router = useRouter(); 
const route = useRoute(); // [NEW]
const currentProject = computed(() => store.currentProject);

const handleBack = () => {
    store.selectProject(null);
};

const views = [
    { id: 'overview', label: 'Overview' },
    { id: 'lifecycle', label: 'Lifecycle' },
    { id: 'team', label: 'Team' },
    { id: 'specs', label: 'Specs' },
    { id: 'docs', label: 'Docs' },
    { id: 'assets', label: 'Assets' },
];

// Initialize from URL or default
const initialView = (route.query.view as string) || 'lifecycle';
const currentView = ref(initialView);

// Watch logic for Deep Linking
watch(currentView, (newVal) => {
    const query = { ...route.query };
    if (newVal !== 'lifecycle') {
       query.view = newVal;
    } else {
       delete query.view;
    }
    router.replace({ query });
});

// Watch URL changes (Back Button support)
watch(() => route.query.view, (newVal) => {
    const v = newVal as string;
    if (v && views.some(x => x.id === v)) {
        currentView.value = v;
    } else {
        currentView.value = 'lifecycle';
    }
});

const columns = [
    { id: 'Triage', label: 'Triage', color: 'bg-yellow-500' },
    { id: 'Confirming', label: 'Confirming', color: 'bg-blue-500' },
    { id: 'In Remediation', label: 'In Remediation', color: 'bg-purple-500' },
    { id: 'Verified', label: 'Verified', color: 'bg-green-500' },
    { id: 'Closed', label: 'Closed', color: 'bg-gray-500' }
];

const getFindings = (status: string) => {
    return store.findings.filter(f => f.status === status);
};

const getSeverityClass = (sev: string, isStrip = false) => {
    const s = sev.toLowerCase();
    if (isStrip) {
        switch (s) {
            case 'critical': return 'bg-red-500';
            case 'high': return 'bg-orange-500';
            case 'medium': return 'bg-yellow-500';
            case 'low': return 'bg-blue-500';
            default: return 'bg-gray-300';
        }
    }
    switch (s) {
        case 'critical': return 'bg-red-50 text-red-600';
        case 'high': return 'bg-orange-50 text-orange-600';
        case 'medium': return 'bg-yellow-50 text-yellow-600';
        case 'low': return 'bg-blue-50 text-blue-600';
        default: return 'bg-ash text-ink/60';
    }
};

const formatDate = (iso: string) => {
    return DateTime.fromISO(iso).toFormat('MMM dd');
};

// Drag and Drop Logic
const onDragStart = (evt: DragEvent, finding: VrkbFinding) => {
    if (evt.dataTransfer) {
        evt.dataTransfer.effectAllowed = 'move';
        evt.dataTransfer.setData('text/plain', finding.id);
        evt.dataTransfer.setData('application/json', JSON.stringify(finding));
    }
};

const onDrop = async (evt: DragEvent, newStatus: string) => {
    const findingId = evt.dataTransfer?.getData('text/plain');
    if (findingId) {
        await store.updateFindingStatus(findingId, newStatus);
    }
};

const openCreateModal = (status: string) => {
    const title = prompt("Finding Title:");
    if (title && store.sections.length > 0) {
        store.createFinding(store.sections[0].id, title, 'Medium', {});
    } else if (!store.sections.length) {
        alert("Please create a section first in the project settings or via API.");
    }
};

onMounted(async () => {
    if (store.currentProject) {
        try {
            await store.fetchFindings(store.currentProject.id);
        } catch (e) {
            console.error("Failed to load findings", e);
        }
    }
});

// Editor Modal State
const showEditor = ref(false);
const editingFinding = ref<VrkbFinding | null>(null);
const editorContent = ref<any>({});

const openEditor = (finding: VrkbFinding) => {
    editingFinding.value = finding;
    editorContent.value = finding.content || {}; 
    showEditor.value = true;
};

const saveEditor = async () => {
    if (editingFinding.value) {
        console.warn("Backend update_finding_content not implemented yet.");
        showEditor.value = false;
    }
};
</script>

<style scoped>
/* Hide scrollbar for cleaner look */
.overflow-x-auto::-webkit-scrollbar {
    height: 6px;
}
.overflow-x-auto::-webkit-scrollbar-thumb {
    background-color: rgba(0,0,0,0.1);
    border-radius: 3px;
}
</style>
